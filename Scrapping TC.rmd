---
title: "Scrapping TC"
author: "Jan Dimter Stransky, Cristobal Ortiz y Martín Venegas"
date: "10/24/2020"
output: html_document
---

# Web Scrapping TC
Descripción: Este RMarkdown realizará la técnica de web-scrapping a la página del Tribunal Constitucional. Se recuperará la información de las sentencias que por materia tengan *Control de constitucionalidad de leyes o tratados (Artículo 93 Nº1)* o *Constitucionalidad de proyectos de ley (Artículo 93 Nº3*. Se acotará a aquellas causas que hayan sido requerimientos por parte de parlamentarios.


```{r Configuración}
# Configuración del .rmd y carga de paquetes.
knitr::opts_chunk$set(echo = FALSE)
## Paquetes
library(tidyverse)
# Parsing of HTML/XML files
library(rvest)
# String manipulation
library(stringr)
# Verbose regular expressions
library(rebus)
# Eases DateTime manipulation
library(lubridate)
```

## Operación
A continuación se desarrolla el web scrapping:
```{r Scrapping, echo=True}
#Carga de la web
TC_link <-'https://www.tribunalconstitucional.cl/sentencias/busqueda-avanzada'
#Lectura del HTML
TC_web <- read_html(TC_link)
#Carga del formulario y relleno de búsqueda
form <- html_form(TC_web)[[3]]
form2 <- set_values(form, materia= "4", texto="Requerimiento")
form2$url <- ""
TC_session <- html_session("https://www.tribunalconstitucional.cl/sentencias/busqueda-avanzada")
TC_conform <- submit_form(session=TC_session, form=form2)
#Lectura del resultado
TC_html <- read_html(TC_conform)
#Extracción tabla de resultados
TC_table <- html_table(TC_conform, fill=TRUE)[[2]]

páginas <-TC_html %>% html_nodes("center a") %>% html_text()%>% .[-length(.)]


txt<-"Requerimiento"
cat<-"4"

#Función superior
scrapTC <- function (cat,txt) {
  TC_link <-'https://www.tribunalconstitucional.cl/sentencias/busqueda-avanzada'
  TC_web <- read_html(TC_link)
  form_base <- html_form(TC_web)[[3]]
  form_beta <- set_values(form_base, materia= cat, texto=txt)
  TC_session <- html_session(TC_link)
  TC_conform <- submit_form(session=TC_session, form=form_beta)
  TC_resultado_beta <- read_html(TC_conform)
  
  #Scrapeo número de páginas
  paginas <-TC_resultado_beta %>% html_nodes("center a") %>% html_text()%>% .[-length(.)]
  #Lista con múltiples forms base
  forms_mult_base<- list(form_base)[rep(1,length(paginas))]
  
 #Creación lista con n formularios rellenados con el número de páginas
  forms_mult_rell <- list()  # 1. output
  for( i in seq_along(paginas)){
    forms_mult_rell[[i]] <- set_values(form_base, materia= cat, texto=txt, pagina =i)}
  submit_forms<-lapply(forms_mult_rell,submit_form,session=TC_session)
  read_results<-lapply(submit_forms,read_html)
  extracc_tablas2<- lapply(read_results,html_nodes,css="form table:last-child table")
  extracc_tablas_final<- lapply(extracc_tablas2,html_table,fill=TRUE,header=TRUE)
  prueba1 <-unlist(extracc_tablas_final,recursive = FALSE)
  #largo_lista <- length(prueba1)
  tabla_síntesis<-Reduce(bind_rows, prueba1)
  return(tabla_síntesis)
}
#Ejemplo, buscaremos sentencias relativas a
#Materia: Control de constitucionalidad de leyes y tratados (Art.19 nº1) ("2")
#Palabra clave: "sexual"
Ejemplo <-scrapTC("2","sexual")
Ejemplo
```